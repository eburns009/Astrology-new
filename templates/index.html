<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Astrology Lab — Tropical + Fagan/Bradley (index.html • {{ app_version or '' }})</title>
  <style>
    :root { --bg:#0b0c10; --card:#11131a; --muted:#a7b0c0; --text:#e8ecf3; --accent:#7cc7ff; }
    html,body{background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0}
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px}
    h1{margin:.2rem 0 1rem 0; font-size:1.5rem}
    .card{background:var(--card); border:1px solid #22283a; border-radius:12px; padding:14px; margin:10px 0}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:end}
    label{display:block; color:#c7d0df; margin-bottom:4px}
    input,select,button{padding:.5rem .6rem; border-radius:10px; border:1px solid #2b3245; background:#0f1320; color:#e8ecf3}
    button{cursor:pointer; background:#14324a}
    button.primary{background:#1b5c85; border-color:#2a81b8}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{border:1px solid #2a3042; padding:.5rem; text-align:left}
    .muted{color:var(--muted)}
    .err{color:#ff9aa2}
    .hint{font-size:.9em;color:#93a4ba}
    ul.results{list-style: none; padding-left: 0}
    ul.results li{margin:.35rem 0; display:flex; gap:8px; align-items:center}
    ul.results form{display:inline}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Astrology Lab ({{ app_version or '—' }})</h1>

    <!-- Location search (GeoNames) -->
    <div class="card">
      <form method="GET" action="/" class="row">
        <div>
          <label>Search city (GeoNames)</label>
          <input name="city" placeholder="e.g., Fort Knox" />
        </div>
        <div>
          <button class="primary" type="submit">Find</button>
        </div>
      </form>
      {% if city_results is not none %}
        {% if city_results and city_results[0]._ok %}
          <p class="hint">Select a result to prefill latitude, longitude, and timezone.</p>
          <ul class="results">
          {% for c in city_results %}
            <li>
              <span>{{ c.name }}, {{ c.admin }}, {{ c.country }} — ({{ c.lat }}, {{ c.lng }})</span>
              <form method="POST" action="/select_city">
                <input type="hidden" name="name" value="{{ c.name }}" />
                <input type="hidden" name="admin" value="{{ c.admin }}" />
                <input type="hidden" name="country" value="{{ c.country }}" />
                <input type="hidden" name="lat" value="{{ c.lat }}" />
                <input type="hidden" name="lng" value="{{ c.lng }}" />
                <button type="submit">Use this</button>
              </form>
            </li>
          {% endfor %}
          </ul>
        {% else %}
          <p class="err">{{ city_results[0].label if city_results else 'No results' }}</p>
        {% endif %}
      {% endif %}
      {% if selected_city %}
        <p class="hint">Selected: {{ selected_city }}</p>
      {% endif %}
    </div>

    <!-- Calc card -->
    <div class="card">
      <form method="POST" action="/" class="row">
        <div>
          <label>Date (YYYY-MM-DD)</label>
          <input name="date" value="{{ date or '1962-07-02' }}" />
        </div>
        <div>
          <label>Time (HH:MM)</label>
          <input name="time" value="{{ time or '23:33' }}" />
        </div>
        <div>
          <label>Timezone (IANA)</label>
          <input name="tzid" value="{{ tzid or 'America/New_York' }}" />
          <div class="hint">If you selected a city above, this may auto-fill from GeoNames.</div>
        </div>
        <div>
          <label><input type="checkbox" name="use_fixed" {% if use_fixed %}checked{% endif %}/> Use fixed UTC offset (no DST)</label>
        </div>
        <div>
          <label>Fixed UTC offset (h)</label>
          <input name="fixed_offset" value="{{ fixed_offset if fixed_offset is not none else '-5' }}" />
        </div>
        <div>
          <label>FB extra offset (°)</label>
          <input name="fb_offset" value="{{ fb_offset if fb_offset is not none else '0.0' }}" />
        </div>
        <div>
          <label>Center</label>
          <select name="center">
            <option value="geo" {% if center == 'geo' %}selected{% endif %}>Geocentric</option>
            <option value="helio" {% if center == 'helio' %}selected{% endif %}>Heliocentric</option>
          </select>
        </div>
        <div>
          <label>House System</label>
          <select name="house_system">
            <option value="EQUAL" {% if house_system == 'EQUAL' %}selected{% endif %}>Equal (Asc centered)</option>
            <option value="PLACIDUS" {% if house_system == 'PLACIDUS' %}selected{% endif %}>Placidus</option>
          </select>
        </div>
        <div>
          <label>Latitude (°)</label>
          <input name="lat" value="{{ lat or '' }}" placeholder="e.g., 37.900" />
        </div>
        <div>
          <label>Longitude (°; West negative)</label>
          <input name="lon" value="{{ lon or '' }}" placeholder="e.g., -85.950" />
        </div>
        <div>
          <button class="primary" type="submit">Compute</button>
        </div>
      </form>

      {% if page_error %}
      <p class="err"><b>Error:</b> {{ page_error }}</p>
      {% endif %}

      {% if results %}
      <p class="muted">Local {{ local_str }} ({{ tzid_display }}) → UTC {{ utc_str }} • JD {{ jd }} • Ayanāṃśa (F/B + extra): {{ ayan_used }}°</p>
      <table>
        <tr>
          <th>Body</th>
          <th>Tropical (°)</th>
          <th>Tropical Sign</th>
          <th>Sidereal F/B (°)</th>
          <th>Sidereal Sign</th>
        </tr>
        {% for r in results %}
          <tr>
            <td>{{ r.name }}</td>
            <td>{{ r.trop }}</td>
            <td>{{ r.trop_sign }}</td>
            <td>{{ r.sid }}</td>
            <td>{{ r.sid_sign }}</td>
          </tr>
        {% endfor %}
      </table>
      {% endif %}

      {% if houses %}
      <h3>Houses ({{ house_system }})</h3>
      <p class="muted">Asc {{ houses.asc|float|round(4) }}° • MC {{ houses.mc|float|round(4) }}°</p>
      <table>
        <tr>
          <th>#</th>
          <th>Cusp (°)</th>
          <th>Sign</th>
        </tr>
        {% for c in houses.cusps %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ '%.6f' % c }}</td>
          <td>{{ (c % 360) // 30 | int }}</td>
        </tr>
        {% endfor %}
      </table>
      {% endif %}
    </div>

    <!-- Ephemeris card -->
    <div class="card">
      <h3 style="margin-top:0">Ephemeris — Fagan/Allen (Sidereal)</h3>
      <form method="POST" action="/ephemeris" class="row">
        <div>
          <label>Start date (ISO; BCE ok as -0500-01-01)</label>
          <input name="eph_start" placeholder="-0500-01-01" />
        </div>
        <div>
          <label>End date (ISO)</label>
          <input name="eph_end" placeholder="1962-07-02" />
        </div>
        <div>
          <label>Step</label>
          <select name="eph_step">
            <option>1 day</option>
            <option>6 hours</option>
            <option>1 hour</option>
          </select>
        </div>
        <div>
          <label>Center</label>
          <select name="eph_center">
            <option value="geo">Geocentric</option>
            <option value="helio">Heliocentric</option>
          </select>
        </div>
        <div>
          <label>FB extra offset (°)</label>
          <input name="fb_offset" value="0.0" />
        </div>
        <div>
          <button class="primary" type="submit">Download CSV</button>
          <button type="submit" formaction="/ephemeris/preview">Preview/Print</button>
        </div>
      </form>
      <p class="muted">CSV columns: ISO_UT, AYAN_FB_PLUS, CENTER, Sun..Pluto (sidereal F/A, decimal degrees). Use Preview/Print for paginated HTML.</p>
    </div>

  </div>
</body>
</html>
